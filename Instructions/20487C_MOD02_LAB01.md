#Module 2: Using Web API

#Lab 1: Developing Web API

###Exercise 1: Create an ASP.NET 5 project with an API controller

####Task 1: Create an ASP.NET 5 project with an API controller

1. Open **Visual Studio 2015**
2. Create a new **ASP.NET Web Application** project, using the **ASP.NET 5 Web API** template, and name it **Mod02**
3. In the **Mode02** project, under the **src** folder, From *Controllers* folder delete *ValuesController.cs* file.

####Task 2: Create model and repository

> **Note:** To keep project simple and focused on Web API we will use in-memory repository. This repository will keep contacts for the duration of the debug session.

1. In the **Mode02** project, under the **src** folder, create new folder and name it **Models**.
2. Add new *class* named **Contacts** to the **Models** folder.
3. Add **Contacts** properties as follows:

	```cs
    public string FirstName { get; set; }
    public string LastName { get; set; }
    public string Company { get; set; }
    public string Email { get; set; }
    public string MobilePhone { get; set; }
```
4. In the **Mode02** project, under the **src** folder, create new folder and name it **Repository**.
	
5. Create new *interface* named **IContactsRepository** to the **Repository** folder.
6. Add the following *using* statement at the beginning of the file:

	```cs
	using Mod02.Models;
```
7. Change interface access modifier to ***public***
9. Add the following definitions to the interface:

	```cs
    void Add(Contacts item);
    IEnumerable<Contacts> GetAll();
    Contacts Find(string key);
    void Remove(string Id);
    void Update(Contacts item);
```
10. Create new *class* named **ContactsRepository** to the **Repository** folder.
11. Implement ***IContactsRepository*** interface.
12. Add the following *class variable*:

	```cs
	static List<Contacts> ContactsList = new List<Contacts>();
```
13. Add the following code snippet in add initialize some data to the repository:

	```cs
	static ContactsRepository()
    {
        ContactsList.Add(new Contacts() { FirstName = "First1", LastName = "Last1", Email = "l1f1@contoso.com", MobilePhone = "111" });
        ContactsList.Add(new Contacts() { FirstName = "First2", LastName = "Last2", Email = "l2f2@contoso.com", MobilePhone = "222", Company="Contoso" });
        ContactsList.Add(new Contacts() { FirstName = "First3", LastName = "Last3", Email = "l3f3@contoso.com", MobilePhone = "333" });
        ContactsList.Add(new Contacts() { FirstName = "First4", LastName = "Last4", Email = "l4f4@contoso.com", MobilePhone = "444", Company="Contoso" });
        ContactsList.Add(new Contacts() { FirstName = "First5", LastName = "Last5", Email = "l5f5@contoso.com", MobilePhone = "555" });

    }
```
14. Implement ***Add** function as follows:

	```cs
	ContactsList.Add(item);
```
14. Implement ***Find*** function as follows:

	```cs
	return ContactsList
            .Where(e => e.MobilePhone.Equals(key))
            .SingleOrDefault();
```
15. Implement ***GetAll*** function as follows:

	```cs
	return ContactsList;
```
16. Implement ***Remove*** function as follows:

	```cs
	var itemToRemove = ContactsList.SingleOrDefault(r => r.MobilePhone == Id);
    if (itemToRemove != null)
    	ContactsList.Remove(itemToRemove);
```
17.  Implement ***Update*** function as follows:

	```cs
    var itemToUpdate = ContactsList.SingleOrDefault(r => r.MobilePhone == item.MobilePhone);
    if (itemToUpdate != null)
    {
        itemToUpdate.FirstName = item.FirstName;
        itemToUpdate.LastName = item.LastName;
        itemToUpdate.Company = item.Company;
        itemToUpdate.Email = item.Email;
        itemToUpdate.MobilePhone = item.MobilePhone;
    }
```

####Task 3: Create controller

1. Add a new **ContactsController** class to the **Model** folder.
2. Add the following *using* statements at the beginning of the file:

	```cs
	using Mod02.Repository;
	using Mod02.Models;
```
3. Add **ContactsRepo** class level variable and decorate it with **[FromServices]** attriute:

	```cs
	[FromServices]
    public IContactsRepository ContactsRepo { get; set; }
```
4. Remove the rest of default controller implementation from the class.
5. Add *GET* method to return all contacts in the repository as follows:

	```cs
	[HttpGet]
    public IEnumerable<Contacts> GetAll()
    {
        return ContactsRepo.GetAll();
    }
```
6.  Add additional *GET* method to return specific contact by id. The method receives id as parameter and performs contact search in the repository.

	```cs
    [HttpGet("{id}")]
    public IActionResult GetById(string id)
    {
        var item = ContactsRepo.Find(id);
        if (item == null)
        {
            return HttpNotFound();
        }
        return new ObjectResult(item);
    }
```
	> **Note:** Our controller already have one parameterless *GET* method. For this method attribute defintion specifying {id} parameter. This will route all requestes with id to the method.   
7. Add the following *POST* method to create new contact and add it to the repository:

	```cs
	[HttpPost]
    public IActionResult Create([FromBody] Contacts item)
    {
        if (item == null)
        {
            return HttpBadRequest();
        }
        ContactsRepo.Add(item);
        return CreatedAtRoute("GetContacts", new { Controller = "Contacts", id = item.MobilePhone }, item);
    }
```
8. Now add the following *DELETE* method to delete contact from the repository by id:

	```cs
	[HttpDelete("{id}")]
    public void Delete(string id)
    {
        ContactsRepo.Remove(id);
    }
```
9. Finally, add the followind *PUT* method to support contact update functionality:

	```cs
	[HttpPut("{id}")]
    public IActionResult Update(string id, [FromBody] Contacts item)
    {
        if (item == null)
        {
            return HttpBadRequest();
        }
        var contactObj = ContactsRepo.Find(id);
        if (contactObj == null)
        {
            return HttpNotFound();
        }
        ContactsRepo.Update(item);
        return new NoContentResult();
    }
```

####Task 4: Modify Startup.cs

1. Open **Startup.cs** file and add the following code snippet to the end of ***ConfigureServices*** function:

	```cs
	services.AddSingleton<IContactsRepository, ContactsRepository>();
```
2. Save all modified files.


#Lab 2: Self hosting and consuming Web API

###Exercise 1: Self hosting Web API

####Task 1: Configuring Kestrel

1. Open the **project.json** file and replace the contents of *commands* node with the following code snippet:

	```JSON
	"Kestel": "Microsoft.AspNet.Server.Kestrel"
```
2. Save **project.json** file. 
3. Change debug profile (drop down associated with "***play***" button in **Visual Studio**) to ***Kestel*** and run the project.
4. **Visual Studio** compiles/launches the project and opens new command line window with hosting information. It specifies the address and port of our web.

	> **Note:** By default, the web site should be listening at [http://localhost:5000](http://localhost:5000).
5. Open web browser and navigate to the address specified in hosting information. Add "**/api/Contacts**" to the URL:

	```URL
	http://localhost:5000/api/Contacts
```

	You shall see the list if objects intialized in repository constrcutor on the web browser (as we not added any contacts to our repository yet) and debug output in command line window.
6. Close command line window or stop the debugging to return to the **Visual Studio***.


####Task 3: Configuring WebListener

1. Open the **project.json** file if closed previously and add the following code snippet to the beginning of the *commands* node:

	```JSON
	"WebListener": "Microsoft.AspNet.Server.WebListener",
```
2. Add the following code snippet to the very end of *dependencies* node:

	```JSON
	,
	"Microsoft.AspNet.Server.WebListener": "1.0.0-rc1-final"
```
3. Change debug profile (drop down associated with "***play***" button in **Visual Studio**) to ***WebListener*** and run the project.
4. **Visual Studio** compiles/launches the project and opens new command line window with hosting information. It specifies the address and port of our web.

	> **Note:** By default, the web site should be listening at [http://localhost:5000](http://localhost:5000).
5. Open web browser and navigate to the address specified in hosting information. Add "**/api/Contacts**" to the URL:

	```URL
	http://localhost:5000/api/Contacts
```

	You shall see the list if objects intialized in repository constrcutor on the web browser (as we not added any contacts to our repository yet) and debug output in command line window.
6. Close command line window or stop the debugging to return to the **Visual Studio***.


###Exercise 2: Consuming Web API

####Task 1: Consuming Web API from Console Application
1. Run


####Task 2: Configuring Web API from HTML/JavaScript
1. Run
